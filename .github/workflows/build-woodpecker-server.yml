name: Build Woodpecker Server

on:
  push:
    branches:
      - main
    paths:
      - "infra/docker/woodpecker-server/**"
      - ".github/workflows/build-woodpecker-server.yml"

  # 주간 자동 빌드 (일요일 03:00 UTC)
  schedule:
    - cron: "0 3 * * 0"

  # 수동 트리거
  workflow_dispatch:
    inputs:
      woodpecker_version:
        description: "Woodpecker version (e.g., 2.3.0, latest)"
        required: false
        default: "latest"
      push_to_hub:
        description: "Push to Docker Hub"
        required: false
        type: boolean
        default: true

env:
  IMAGE_NAME: woodpecker-server
  DOCKER_HUB_REPO: mindulle/woodpecker-server

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest Woodpecker version
        id: woodpecker_version
        run: |
          if [ "${{ github.event.inputs.woodpecker_version }}" != "" ]; then
            VERSION="${{ github.event.inputs.woodpecker_version }}"
          else
            # GitHub API에서 최신 릴리스 가져오기
            VERSION=$(curl -s https://api.github.com/repos/woodpecker-ci/woodpecker/releases/latest | jq -r .tag_name | sed 's/^v//')
            echo "Latest Woodpecker version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Generate tags
        id: tags
        run: |
          VERSION="${{ steps.woodpecker_version.outputs.version }}"
          DATE=$(date +%Y%m%d)

          TAGS="${DOCKER_HUB_REPO}:latest"
          TAGS="${TAGS},${DOCKER_HUB_REPO}:${VERSION}"
          TAGS="${TAGS},${DOCKER_HUB_REPO}:${VERSION}-custom"
          TAGS="${TAGS},${DOCKER_HUB_REPO}:${VERSION}-custom-${DATE}"

          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "Generated tags: $TAGS"

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./infra/docker/woodpecker-server
          file: ./infra/docker/woodpecker-server/Dockerfile
          build-args: |
            WOODPECKER_VERSION=${{ steps.woodpecker_version.outputs.version }}
          push: ${{ github.event.inputs.push_to_hub != 'false' }}
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Test image
        run: |
          docker run --rm \
            -e WOODPECKER_HOST=http://test.local \
            -e WOODPECKER_AGENT_SECRET=test \
            --entrypoint sh \
            ${DOCKER_HUB_REPO}:latest \
            -c "woodpecker-server --version && curl --version && jq --version"

      - name: Generate build summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # Woodpecker Server Build Summary

          ## Build Information
          - **Woodpecker Version**: ${{ steps.woodpecker_version.outputs.version }}
          - **Build Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **Triggered by**: ${{ github.event_name }}

          ## Docker Tags
          \`\`\`
          ${{ steps.tags.outputs.tags }}
          \`\`\`

          ## Pull Command
          \`\`\`bash
          docker pull ${DOCKER_HUB_REPO}:latest
          docker pull ${DOCKER_HUB_REPO}:${{ steps.woodpecker_version.outputs.version }}
          \`\`\`

          ## Deployment
          \`\`\`bash
          # Update docker-compose.yml
          docker-compose pull woodpecker-server
          docker-compose up -d woodpecker-server

          # Check logs
          docker-compose logs -f woodpecker-server
          \`\`\`
          EOF
